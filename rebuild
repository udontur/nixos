#!/usr/bin/env bash

source assets/bla/bla.sh
trap BLA::stop_loading_animation SIGINT

sudo git add .

read -p "Which machine (w or l)? " machine_type

if [[ $machine_type = "l" ]]; then
    echo "\rRebuilding in Laptop mode."
    BLA::start_loading_animation "${BLA_passing_dots[@]}"
        sudo nixos-rebuild switch --flake ./hosts/laptop#laptop --impure &> nixos-switch.log || (cat nixos-switch.log | grep --color error && exit 1)
    BLA::stop_loading_animation
else
    echo "\rRebuilding in Workstation mode."
    BLA::start_loading_animation "${BLA_passing_dots[@]}"
        sudo nixos-rebuild switch --flake ./hosts/workstation#workstation --impure &> nixos-switch.log || (cat nixos-switch.log | grep --color error && exit 1)
    BLA::stop_loading_animation
fi

notify-send "\r\rNixOS finished rebuilding!"
echo "\r\rNixOS finished rebuilding!"

sudo chown -R udontur:777 ./.git

if [[ $machine_type = "l" ]]; then
    currentDate=$(date +"LAP: %Y-%m-%d %H:%M:%S")
    git commit -m "$currentDate" &> git-commit.log
else
    currentDate=$(date +"WRK: %Y-%m-%d %H:%M:%S")
    git commit -m "$currentDate" &> git-commit.log
fi

read -p "Back it up? " user_input

if [[ $user_input =~ ^[Yy]$ ]]; then
    git push origin main &> git-sync.log || (git push origin main && exit 1)
    if [ $? -ne 0 ]; then
        echo "\r\rFAILED to back up :c"
        exit 1
    else
        echo "\r\rBacked up :D"
    fi
else
    echo "\rNOT backed up :c"
fi
