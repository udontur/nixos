#!/usr/bin/env bash

source assets/bla/bla.sh
trap BLA::stop_loading_animation SIGINT

sudo git add .

read -p "Which machine (w or l)? " machine_type

if [[ $machine_type = "l" ]]; then
    echo "Rebuilding in Laptop mode:"
    BLA::start_loading_animation "${BLA_passing_dots[@]}"
        sudo nixos-rebuild switch --flake ./hosts/laptop# --impure &> nixos-switch.log || (cat nixos-switch.log | grep --color error && exit 1)
    BLA::stop_loading_animation
else
    echo "Rebuilding in Workstation mode:"
    BLA::start_loading_animation "${BLA_passing_dots[@]}"
        sudo nixos-rebuild switch --flake ./hosts/workstation# --impure &> nixos-switch.log || (cat nixos-switch.log | grep --color error && exit 1)
    BLA::stop_loading_animation
fi

notify-send "NixOS finished rebuilding!"
echo "NixOS finished rebuilding!"

sudo chown -R udontur:777 ./.git
currentDate=$(date +"SYS: %Y-%m-%d %H:%M:%S")
git commit -m "$currentDate" &> git-commit.log

read -p "Back it up? " user_input

if [[ $user_input =~ ^[Yy]$ ]]; then
    git push origin main &> git-sync.log || (git push origin main && exit 1)
    if [ $? -ne 0 ]; then
        echo "FAILED to back up :c"
        exit 1
    else
        echo "Backed up :D"
    fi
else
    echo "NOT backed up :c"
fi
